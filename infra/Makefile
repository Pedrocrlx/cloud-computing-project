# Makefile
# Extrai a lista de clientes do script de config para iterar no make
CLIENTS := $(shell grep 'CLIENTS_MAP\[' scripts/env_config.sh | cut -d'"' -f2)

.PHONY: all clean up hosts init validate test

all: clean up hosts init validate

clean:
	@echo "ğŸ§¹ A limpar infraestrutura..."
	rm -rf .terraform terraform.tfstate.d .terraform.lock.hcl
	minikube delete --all
	@echo "âœ¨ Limpeza concluÃ­da."

up:
	@echo "ğŸš€ A Provisionar Clusters..."
	terraform init
	@for client in $(CLIENTS); do \
		echo "------------------------------------"; \
		echo "ğŸ—ï¸  CLIENTE: $$client"; \
		terraform workspace select $$client || terraform workspace new $$client; \
		terraform apply -auto-approve; \
	done
	@echo "âœ… Terraform finalizado."

hosts:
	@chmod +x scripts/update_hosts.sh
	@./scripts/update_hosts.sh

init:
	@chmod +x scripts/init_odoo.sh
	@./scripts/init_odoo.sh

validate:
	@echo "ğŸ§ª A testar endpoints finais..."
	@# Script simples embutido para validar
	@bash -c 'source scripts/env_config.sh; \
	for client in "$${!CLIENTS_MAP[@]}"; do \
		for env in $${CLIENTS_MAP[$$client]}; do \
			url="https://odoo.$$env.$$client.local"; \
			code=$$(curl -k -s -o /dev/null -w "%{http_code}" $$url); \
			echo "Checking $$url ... HTTP $$code"; \
		done; \
	done'

test: validate